rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- Helper functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.role == "superAdmin";
    }
    function isAdmin(companyId) {
      return isSignedIn() && request.auth.token.role == "admin" && request.auth.token.companyId == companyId;
    }
    function isVendor(companyId) {
      return isSignedIn() && request.auth.token.role == "vendor" && request.auth.token.companyId == companyId;
    }
    function hasVendorFilter() {
      return request.query.filters != null && request.query.filters.any((f) => f.field.path == "vendorId" && f.value.stringValue == request.auth.uid);
    }

    // --- Top-level collections ---
    match /vendors/{vendorId} {
      allow read: if isSuperAdmin() || isAdmin(resource.data.companyId) || isVendor(resource.data.companyId);
      allow write: if isSuperAdmin() || isAdmin(request.resource.data.companyId) || isVendor(request.resource.data.companyId);
    }
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSuperAdmin() || isAdmin(request.auth.token.companyId);
      allow write: if isSuperAdmin() || (isAdmin(request.resource.data.companyId) && request.auth.uid == userId);
    }

    // --- Companies and subcollections ---
    match /companies/{companyId} {
      allow get: if isSuperAdmin() || isAdmin(companyId);
      allow list: if isSuperAdmin() || isAdmin(request.auth.token.companyId);
      allow write: if isSuperAdmin() || isAdmin(companyId);
    }
    match /companies/{companyId}/tasks/{taskId} {
      allow get: if isSuperAdmin() || isAdmin(companyId) || (isVendor(companyId) && resource.data.vendorId == request.auth.uid);
      allow list: if isSuperAdmin() || isAdmin(companyId) || (isVendor(companyId) && hasVendorFilter());
      allow create, update, delete: if isSuperAdmin() || isAdmin(companyId) || (isVendor(companyId) && resource.data.vendorId == request.auth.uid);
    }
    match /companies/{companyId}/jobs/{jobId} {
      allow get: if isSuperAdmin() || isAdmin(companyId) || (isVendor(companyId) && resource.data.vendorId == request.auth.uid);
      allow list: if isSuperAdmin() || isAdmin(companyId) || (isVendor(companyId) && hasVendorFilter());
      allow create, update, delete: if isSuperAdmin() || isAdmin(companyId);
    }
    match /companies/{companyId}/shares/{shareId} {
      allow get: if isSuperAdmin() || isAdmin(companyId) || (isVendor(companyId) && resource.data.vendorId == request.auth.uid);
      allow list: if isSuperAdmin() || isAdmin(companyId) || (isVendor(companyId) && hasVendorFilter());
      allow create, update, delete: if isSuperAdmin() || isAdmin(companyId) || (isVendor(companyId) && resource.data.vendorId == request.auth.uid);
    }

    // --- Disable top-level collections except vendors/users ---
    match /tasks/{taskId} { allow get, list, create, update, delete: if false; }
    match /jobs/{jobId} { allow get, list, create, update, delete: if false; }
    match /shares/{shareId} { allow get, list, create, update, delete: if false; }
    match /files/{fileId} { allow get, list, create, update, delete: if false; }
  }
}